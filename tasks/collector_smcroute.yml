---
# Install  SMCRoute to join channels


#iptv_analyzer_collector_install_smcroute
- name: install smcroute
  package:
    name: smcroute
    state: present
  become: true

- name: Check that VPN IP address is active
  assert:
    that: ansible_wg0.ipv4.address is defined

# - name: Check if smcroute.conf.j2 exists
#   stat:
#     path: "{{ playbook_dir }}/templates/etc/smcroute.conf.j2"
#   register: stat_result_snmd_conf
#   delegate_to: localhost
- name: Create the users for collector
  community.mysql.mysql_query:
    login_user: root
    login_host: "{{ iptv_analyzer_database_server }}"
    login_password: "{{ iptv_analyzer_database_root_password }}"
    login_unix_socket: "{{ iptv_analyzer_database_mariadb_socket }}"
    query: "{{ iptv_analyzer_collector_mysql_query }}"
#  no_log: true
  delegate_to: localhost
  become: true
  register: add_db_user_to_central_server

- name: Copy template to device
  template:
    src: etc/smcroute.conf.j2
    dest: /etc/smcroute.conf
    owner: root
    group: root
    mode: '0644'
  become: true
  register: template_changed
# Copy template to device

- name: Restart smcroute service
  service:
    name: smcroute
    state: restarted
  when: template_changed.changed
  become: true

- name: Start snmpd service
  service:
    name: smcroute
    state: started
  when: not template_changed.changed
  become: true
